# Windows Service Misconfigurations

Windows services run executables on a schedule or when triggered by an event. Services can run in the security context of any user, including `SYSTEM`. Misconfigurations in these services are common vectors for local privilege escalation and lateral movement.

---

## Service Misconfiguration Privilege Escalation Process

1. [[service-misconfigurations#Query Services|Query all the machine's services, active and inactive]]
2. For each service, check the following:
	- [[service-misconfigurations#Check the Effective Access to a Service|Modifiable Service]]: When a low-privileged user can modify a service that is configured to run by a high-privileged user, they can modify the service to run an arbitrary executable
		- You can also [[accesschk#Determine the Services that All Members of GROUP Can Write To|determine all services that members of a particular group can write to]]
	- [[service-misconfigurations#Modifying a Service's Registry Entry|Modifiable Service Registry Entry]]: When a low-privileged user can write to the registry key that contains the path of the service's executable, they can write the path of an arbitrary executable
	- [[service-misconfigurations#Modifying a Service's Binary|Modifiable Service Binary]]: When a low-privileged user can write to a high-privileged service's executable, they can swap out the executable for an arbitrary one
	- [[service-misconfigurations#Exploiting a Service with Unquoted Spaced Binary Path|Unquoted & Spaced Service Binary Path]]: When a high-privileged service's executable path is unquoted and contains spaces, a low-privileged user may be able to trick the service into running an arbitrary executable
	- [[service-misconfigurations#DLL Hijacking a Service|DLL Hijacking]]: A low-privileged user may be able to leverage DLL hijacking to trigger the high-privileged service executable into running a malicious DLL

---

## Query Services

- [[sc#Query Services]]
- [[wmic#Query Services]]
- [[powershell-services|powershell > Query Services]]

---

## Modify a Service's Binary Path

1. Check your [[service-misconfigurations#Check the Effective Access to a Service|effective access to the service]].
2. If you have write access:
	- Stage an arbitrary [[service-binary-source|service binary]] to the target
	- Re-configure the service's `binpath`
		- [[sc#Update a Service's Executable Path|sc]]
			- You can either set `binpath` to the path of an arbitrary [[service-binary-source|service binary]] or to a command (i.e., `net localgroup administrators tgihf /add`)
	- If the service is active, [[sc#Stop a Local Service|stop it]]
	- [[sc#Start a Local Service|Start]] the service

---

## Check the Effective Access to a Service

- [[accesschk#Determine the Effective Access of a Particular Windows Service|accesschk]]
- [[sharpup#Check for Modifiable Services|SharpUp]]

---

## Modifying a Service's Registry Entry

1. Check your [[service-misconfigurations#Check the Effective Access to a Service's Registry Entry|effective access on the service's registry entry]].
2. If you have write access:
	- Stage an arbitrary [[service-binary-source|service binary]] to the target
	- Update the service's registry entry with the binary path of the malicious service binary
		- [[reg#Update a Service's Registry Key's Binary Path|reg]]
		- [[powershell-registry#Update a Service's Registry Key's Binary Path|powershell]]
	- If the service is active, [[sc#stop a Local Service|stop it]]
	- [[sc#Start a Local Service|Start]] the service

---

## Check the Effective Access to a Service's Registry Entry

- [[powershell-acls#View a Registry Key's DACL|powershell]]
- [[sharpup#Check for Modifiable Service Registry Keys|SharpUp]]

---

## Modifying a Service's Binary

1. [[service-misconfigurations#Determine a Service's Binary Path|Determine the service's binary path]].
2. Check your [[service-misconfigurations#Determine the Effective Access on a Service Binary or its Folder|effective access on the service's binary (and the binary's directory)]].
3. If you have write access:
	- Stage an arbitrary [[service-binary-source|service binary]] to the target
	- Make a copy of the legitimate service binary and overwrite the original with the malicious one
	- If the service is active, [[sc#stop a Local Service|stop it]]
	- [[sc#Start a Local Service|Start]] the service

---

## Determine the Effective Access on a Service Binary or its Folder

- [[icacls]]
- [[accesschk#Determine the Effective Access to a Particular File|accesschk]]
- [[powershell-acls]]
- [[sharpup#Check for Modifiable Service Binaries|SharpUp]]

---

## Exploiting a Service with Unquoted & Spaced Binary Path

1. Determine services whose binary paths are unquoted and contain spaces
	- [[powerup#Run All Local Privilege Escalation Checks|PowerUp]]
	- [[sharpup#Check for Unquoted Service Binary Paths|SharpUp]]
2. For each of those potentially vulnerable services:
	- See if you can write an arbitrary binary ahead in the search order
		- The search order is specified [[unquoted-and-spaced-service-binary-paths|here]]
	- If you can, write the binary
	- Restart the service

---

## DLL Hijacking a Service

1. Determine services who may be vulnerable to DLL hijacking
	- [[powerup#Run All Local Privilege Escalation Checks|PowerUp]]
	- [[sharpup#Check for Hijackable DLLs|SharpUp]]
2. For each of those potentially vulnerable services:
	- For each potentially hijackable DLL:
		- Confirm the DLL can be replaced
			- [[icacls]]
			- [[accesschk#Determine the Effective Access to a Particular File|accesschk]]
		- If you can replace the file, do so
		- Wait for the service to restart or restart it yourself
	
---

## Determine a Service's Binary Path

- [[sc#Query Service|sc]]
- [[wmic#Query Services|wmic]]
- [[powershell-services#List Services with Executable Path Included|powershell]]
