# Rotten Potato Vulnerability

A general vulnerability in many Windows operating systems that allows a user account with the `SeImpersonate` privilege (generally some kind of service account) to elevate to `NT AUTHORITY\SYSTEM`. Discovered in 2016.

This works in three movements:

1. Trick the `NT AUTHORITY\SYSTEM` user account into authenticating via NTLM to an attacker-controlled TCP endpoint. This is achieved by making a legitimate Windows API call that triggers a COM server to authenticate to the attacker-controlled endpoint.
2. Man-in-the-middle this authentication attempt (NTLM relay) to locally negotiate an [[access-tokens|access token]] for the `NT AUTHORITY\SYSTEM` account. This is achieved by a mix of forwarding the COM traffic to the legitimate RPC endpoint on port 135 and making more Windows API calls.
3. Once the [[access-tokens|access token]] has been negotiated, impersonate it. This is the step that requires the `SeImpersonate` privilege, which most service accounts have. This step can also be achieved by a user account that has the `SeAssignPrimaryToken` privilege.

---

## Exploits

The de facto exploit for this vulnerability is [JuicyPotato](https://github.com/ohpe/juicy-potato), which allows you to customize the DCOM CLSID, TCP endpoint, and even the process creation mode depending on whether your context has `SeImpersonate` privilege or `SeAssignPrimaryToken`. The repository contains a binary release of the exploit.

The original exploit, but less customizable than JuicyPotato, can be found [here](https://github.com/breenmachine/RottenPotatoNG).

There is also a Metasploit module at `exploit/windows/local/ms16_075_reflection`.

---

## References

[Fox Glove Security's Original Writeup](https://foxglovesecurity.com/2016/09/26/rotten-potato-privilege-escalation-from-service-accounts-to-system/)

[HackTrick's Windows Privilege Escalation - Token Abuse Page](https://book.hacktricks.xyz/windows/windows-local-privilege-escalation/privilege-escalation-abusing-tokens)
